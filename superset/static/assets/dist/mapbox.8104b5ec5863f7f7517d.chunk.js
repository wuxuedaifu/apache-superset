(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{1679:function(t,e,o){"use strict";var r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},i=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),a=f(o(54)),n=f(o(1)),s=f(o(0)),l=f(o(13)),u=f(o(2472)),p=f(o(1669)),d=f(o(2850)),c=f(o(2457)),g=o(248);function f(t){return t&&t.__esModule?t:{default:t}}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function m(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function v(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}o(2856);var w=function(){},b=function(t){function e(){return h(this,e),m(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return v(e,t),i(e,[{key:"componentDidMount",value:function(){this.redraw()}},{key:"componentDidUpdate",value:function(){this.redraw()}},{key:"drawText",value:function(t,e){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=110,i=o.fontHeight,a=void 0===i?0:i,n=o.label,s=void 0===n?"":n,l=o.radius,u=void 0===l?0:l,p=o.rgb,d=void 0===p?[0,0,0]:p,c=o.shadow,f=void 0!==c&&c,h=1.8*u,m=(0,g.rgbLuminance)(d[1],d[2],d[3]);t.globalCompositeOperation="source-over",t.fillStyle=m<=r?"white":"black",t.font=a+"px sans-serif",t.textAlign="center",t.textBaseline="middle",f&&(t.shadowBlur=15,t.shadowColor=m<=r?"black":"");var v=t.measureText(s).width;if(v>h){var w=a/v;t.font=w*h+"px sans-serif"}t.fillText(s,e[0],e[1]),t.globalCompositeOperation=this.props.compositeOperation,t.shadowBlur=0,t.shadowColor=""}},{key:"redraw",value:function(){var t=this.props,e=window.devicePixelRatio||1,o=this.refs.overlay.getContext("2d"),r=t.dotRadius,i=new c.default(t),n=t.rgb,s=[],l=-1;t.locations.forEach((function(e,o){if(e.get("properties").get("cluster")){var r=e.get("properties").get("metric")?e.get("properties").get("metric"):e.get("properties").get("point_count");r instanceof p.default.List&&(r=r.toArray(),r="mean"===t.aggregatorName?a.default.mean(r):"median"===t.aggregatorName?a.default.median(r):"stdev"===t.aggregatorName?a.default.deviation(r):a.default.variance(r)),r=(0,g.isNumeric)(r)?a.default.round(r,2):e.get("properties").get("point_count"),l=Math.max(r,l),s[o]=r}}),this),o.save(),o.scale(e,e),o.clearRect(0,0,t.width,t.height),o.globalCompositeOperation=t.compositeOperation,!t.renderWhileDragging&&t.isDragging||!t.locations||t.locations.forEach((function(e,u){var p=i.project(t.lngLatAccessor(e)),d=[a.default.round(p[0],1),a.default.round(p[1],1)];if(d[0]+r>=0&&d[0]-r<t.width&&d[1]+r>=0&&d[1]-r<t.height)if(o.beginPath(),e.get("properties").get("cluster")){var c=s[u],f=a.default.round(Math.pow(c/l,.5)*r,1),h=a.default.round(.5*f,1),m=o.createRadialGradient(d[0],d[1],f,d[0],d[1],0);m.addColorStop(1,"rgba("+n[1]+", "+n[2]+", "+n[3]+", 0.8)"),m.addColorStop(0,"rgba("+n[1]+", "+n[2]+", "+n[3]+", 0)"),o.arc(d[0],d[1],f,0,2*Math.PI),o.fillStyle=m,o.fill(),(0,g.isNumeric)(c)&&(c>=1e4?c=Math.round(c/1e3)+"k":c>=1e3&&(c=Math.round(c/100)/10+"k"),this.drawText(o,d,{fontHeight:h,label:c,radius:f,rgb:n,shadow:!0}))}else{var v=r/6,w=e.get("properties").get("radius"),b=e.get("properties").get("metric"),y=null===w?v:w,O=void 0;if(null!==w){var x=t.lngLatAccessor(e)[1];"Kilometers"===t.pointRadiusUnit?(O=a.default.round(y,2)+"km",y=(0,g.kmToPixels)(y,x,t.zoom)):"Miles"===t.pointRadiusUnit&&(O=a.default.round(y,2)+"mi",y=(0,g.kmToPixels)(y*g.MILES_PER_KM,x,t.zoom))}null!==b&&(O=(0,g.isNumeric)(b)?a.default.round(b,2):b),y||(y=v),o.arc(d[0],d[1],a.default.round(y,1),0,2*Math.PI),o.fillStyle="rgb("+n[1]+", "+n[2]+", "+n[3]+")",o.fill(),void 0!==O&&this.drawText(o,d,{fontHeight:a.default.round(y,1),label:O,radius:y,rgb:n,shadow:!1})}}),this),o.restore()}},{key:"render",value:function(){var t=0,e=0;this.context.viewport&&(t=this.context.viewport.width,e=this.context.viewport.height);var o=this.props.globalOpacity,r=window.devicePixelRatio||1;return n.default.createElement("canvas",{ref:"overlay",width:t*r,height:e*r,style:{width:t+"px",height:e+"px",position:"absolute",pointerEvents:"none",opacity:o,left:0,top:0}})}}]),e}(n.default.Component);b.propTypes={locations:s.default.instanceOf(p.default.List).isRequired,lngLatAccessor:s.default.func,renderWhileDragging:s.default.bool,globalOpacity:s.default.number,dotRadius:s.default.number,dotFill:s.default.string,compositeOperation:s.default.string},b.defaultProps={lngLatAccessor:function(t){return[t.get(0),t.get(1)]},renderWhileDragging:!0,dotRadius:4,dotFill:"#1FBAD6",globalOpacity:1,compositeOperation:"source-over"},b.contextTypes={viewport:s.default.object,isDragging:s.default.bool};var y=function(t){function e(t){h(this,e);var o=m(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),r=o.props.viewportLongitude||g.DEFAULT_LONGITUDE,i=o.props.viewportLatitude||g.DEFAULT_LATITUDE;return o.state={viewport:{longitude:r,latitude:i,zoom:o.props.viewportZoom||g.DEFAULT_ZOOM,startDragLngLat:[r,i]}},o.onViewportChange=o.onViewportChange.bind(o),o}return v(e,t),i(e,[{key:"onViewportChange",value:function(t){this.setState({viewport:t}),this.props.setControlValue("viewport_longitude",t.longitude),this.props.setControlValue("viewport_latitude",t.latitude),this.props.setControlValue("viewport_zoom",t.zoom)}},{key:"render",value:function(){var t=new c.default({width:this.props.sliceWidth,height:this.props.sliceHeight,longitude:this.state.viewport.longitude,latitude:this.state.viewport.latitude,zoom:this.state.viewport.zoom}),e=t.unproject([0,0]),o=t.unproject([this.props.sliceWidth,this.props.sliceHeight]),i=[e[0],o[1],o[0],e[1]],a=this.props.clusterer.getClusters(i,Math.round(this.state.viewport.zoom)),s=void 0!==this.state.viewport.isDragging&&this.state.viewport.isDragging;return n.default.createElement(u.default,r({},this.state.viewport,{mapStyle:this.props.mapStyle,width:this.props.sliceWidth,height:this.props.sliceHeight,mapboxApiAccessToken:this.props.mapboxApiKey,onViewportChange:this.onViewportChange}),n.default.createElement(b,r({},this.state.viewport,{isDragging:s,width:this.props.sliceWidth,height:this.props.sliceHeight,locations:p.default.fromJS(a),dotRadius:this.props.pointRadius,pointRadiusUnit:this.props.pointRadiusUnit,rgb:this.props.rgb,globalOpacity:this.props.globalOpacity,compositeOperation:"screen",renderWhileDragging:this.props.renderWhileDragging,aggregatorName:this.props.aggregatorName,lngLatAccessor:function(t){var e=t.get("geometry").get("coordinates");return[e.get(0),e.get(1)]}})))}}]),e}(n.default.Component);y.propTypes={aggregatorName:s.default.string,clusterer:s.default.object,setControlValue:s.default.func,globalOpacity:s.default.number,mapStyle:s.default.string,mapboxApiKey:s.default.string,pointRadius:s.default.number,pointRadiusUnit:s.default.string,renderWhileDragging:s.default.bool,rgb:s.default.array,sliceHeight:s.default.number,sliceWidth:s.default.number,viewportLatitude:s.default.number,viewportLongitude:s.default.number,viewportZoom:s.default.number},t.exports=function(t,e,o){var i=a.default.select(t.selector),s=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/.exec(e.data.color);if(null!==s){var u=e.data.aggregatorName,p=void 0;p="sum"!==u&&e.data.customMetric?"min"===u?Math.min:"max"===u?Math.max:function(t,e){return t instanceof Array?e instanceof Array?t.concat(e):(t.push(e),t):e instanceof Array?(e.push(t),e):[t,e]}:function(t,e){return t+e};var c=(0,d.default)({radius:e.data.clusteringRadius,maxZoom:16,metricKey:"metric",metricReducer:p});c.load(e.data.geoJSON.features),i.selectAll("*").remove(),l.default.render(n.default.createElement(y,r({},e.data,{rgb:s,sliceHeight:t.height(),sliceWidth:t.width(),clusterer:c,pointRadius:60,aggregatorName:u,setControlValue:o||w})),i.node())}else t.error("Color field must be of form 'rgb(%d, %d, %d)'")}},2856:function(t,e,o){}}]);